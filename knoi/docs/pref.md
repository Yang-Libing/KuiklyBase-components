# KNOI线程调用选用 Service 决策表

| kotlin 侧调用线程 |  arkTs 侧注册线程 | 是否需要切换线程|最终决策注册实例线程|备注|
| --- | --- | --- | --- | --- |
|   主线程 | 主线程 | 否 | 主线程|无需切换线程直接调用|
|   主线程 | worker 线程| 禁止 | 主线程|主线程必须调用主线程注册的服务|
| 子线程 |   主线程|是 | 主线程|没有注册 worker 线程实例则使用主线程实例|
| 子线程 |   worker 线程|  是|  worker 线程|loadbalance 只在这种情况下生效|

**注意：需要负载均衡的 KNOI 服务只有在调用方和被调用方都可以在非主线程中执行才可进行对应的性能优化**

**注意：负载均衡之后单例将不再是单例而是双例，分别是主线程单例和所有的子线程共享一个单例**

**注意：负载均衡之后单例将不再是单例而是双例，分别是主线程单例和所有的子线程共享一个单例**

**注意：负载均衡之后单例将不再是单例而是双例，分别是主线程单例和所有的子线程共享一个单例**

# KNOI 性能优化最佳实践

## 0. 对于 Kotlin 已经通过 Kotlin Native 支持或者已经通过桥接鸿蒙的 C 层已经支持的接口，直接在 kotlin 侧调用对应的 C 代码执行即可，例如日志和时间戳。

## 1. 调用线程优化

如果调用方和被调用方都可以在子线程中执行，**建议除了在主线程中注册一份 arkTs 服务之外（必须注册）**，可以在Worker 线程中也注册一份 arkts 的实现，在 KNOI 服务发现的过程中会自动进行负载平衡

## 2. 值和回调进行Kotlin侧缓存

1. 对于 arkts 侧不会变化的值建议使用 getApi 服务获取后使用单例或者其他方式缓存在 Kotlin 侧，在后续获取直接避免通过 KNOI 进行桥接，可以大幅增加服务性能
2. 对于 arkts 侧会变化的值或者监听或者 listener，建议不要在 arkTS 侧进行观察者或 callback的管理。最佳做法是只绑定一个 KNOI 的监听回调，通过 Kotlin 侧对观察者进行通知。避免 callback 或者观察者增多后性能出现大幅度劣化。

## 3. KNOI 服务单一职责

1. 服务建议为无状态的纯函数，缓存和状态建议在 Kotlin 侧进行编写。可以大大减轻跨 runtime 调用过程的阻塞，结合缓存，可以大幅度减缓非首次调用的性能问题
